<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="generator" content="PSPad editor, www.pspad.com">
  <title>WebAudio Chain Factory</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7/jquery.js"></script>
  
  <script type="text/javascript" src="js/webaudio/wa_context.js"></script>
  <script type="text/javascript" src="js/external/dsp.js"></script>
  <style type="text/css">
    DIV.chain {
      height: 100px;
      border: 1px dotted gray;
      margin: 20px;
    }
    
    .chain .node, .chain-source {
      float: left;
      height: 100%;
      border: 1px dotted gray;
      margin: 2px;
    }
    
    .controlls {
      float: left;
      height: 100%;
    }
    
    DIV.chain INPUT.btn-source {
      float: left;
      position: relative;
      height: 100%;
    }
    
    DIV.chain INPUT.btn-node {
      float: right;
      position: relative;
      height: 100%;
    }
  </style>
  
  <script type="text/javascript">
    
    var urls = {
      'Human voice': 'sounds/human-voice.mp4',
      'melody': 'sounds/melody.mp3',
      'note': 'sounds/piano/a1.wav.mp3'
    };
    
    var types = {
      'sine': DSP.SINE,
      'square': DSP.SQUARE,
      'saw': DSP.SAW,
      'triangle': DSP.TRIANGLE
    };
    const SAMPLE_RATE = 44100;
    const NUM_SAMPLES = 65536;
    const NUM_CHANNELS = 2;
    
    
    var buffers = {};
    var context = null;
    
    $(document).ready(function() {
      context = new WAContext();
      for (var u in urls) {
        context.loadBuffer(urls[u], function(name) {
          return function(buffer) {
            buffers[name] = buffer;
          }
        }(u));
      }
    });
    
    function selectSourceNode(callback) {
      // callback(new SourceNode(buffers));
      callback(new SourceNodeOscillator());
    }
    
    
    function Node(name) {
      this.name = name;
    }
    
    Node.prototype.render = function(container) {
      container.append($('<span class="node">' + this.name + '</span>'));
    }
    
    
    function SourceNode(buffers) {
      this.buffers = buffers;
      
      this.render = function(container) {
        var select = $('<select>');
        select.append($('<option value="0">None</option>'));
        for (var u in this.buffers) {
          select.append($('<option value="' + u + '">' + u + '</option>'));
        }
        
        select.change(this.onBufferChanged.bind(this));
        
        container.append(select);
        
        var id = 'source' + Math.random();
        var looping = $('<input type="checkbox" id="' + id + '"/>'); 
        looping.click(this.loopChanged.bind(this));
        container.append(select, $('<br>'), looping, $(' - <label for="' + id + '">Loop</label>'));
        
        this.select = select;
        this.looping = looping;
      };
      
      this.isLoop = function() {
        return this.looping.attr('checked') ? true : false;
      };
      
      this.loopChanged = function() {
        if (this.source) {
          this.source.looping = this.isLoop(); 
        }
      }
      
      this.onBufferChanged = function() {
        if (0 == this.select.val()) {
          this.source.noteOff(0);
          return;
        }
        
        if (this.source) {
          this.source.buffer = this.buffers[this.select.val()];
          this.source.noteOn(0);
        }
      }
      
      this.stop = function() {
        if (!this.source)
          return;
          
        this.source.noteOff(0); 
        this.source = null;
      };
      
      this.play = function(context, destination) {
        if (0 == this.select.val())
          return null;
          
        this.source = context.playBuffer(this.buffers[this.select.val()]);
        this.source.connect(destination);
        this.source.looping = this.isLoop();
      }
    }
    
    
    
    
    function SourceNodeOscillator() {
      this.buffer = null;
      
      this.render = function(container) {
        var select = $('<select>');
        select.append($('<option value="0">None</option>'));
        for (var t in types) {
          select.append($('<option value="' + t + '">' + t + '</option>'));
        }
        select.change(this.onTypeChanged.bind(this));
        
        var id = Math.random();
        var looping = $('<input type="checkbox" id="' + id + '"/>'); 
        looping.click(this.loopChanged.bind(this));
        container.append(select, $('<br>'), looping, $(' - <label for="' + id + '">Loop</label>'));
        this.select = select;
        this.looping = looping;
      };
      
      this.isLoop = function() {
        return this.looping.attr('checked') ? true : false;
      };
      
      this.loopChanged = function() {
        if (this.source) {
          this.source.looping = this.isLoop(); 
        }
      }
      
      this.onTypeChanged = function() {
        if (0 == this.select.val()) {
          this.source.noteOff(0);
          return;
        }
        
        if (this.source) {
          var osc = new Oscillator(types[this.select.val()], 440, 0.5, NUM_SAMPLES, SAMPLE_RATE);
          osc.generate();
          this.source.buffer.getChannelData(0).set(osc.signal);
          this.source.buffer.getChannelData(1).set(osc.signal);
          this.source.noteOn(0);
        }
      };
      
      this.stop = function() {
        if (!this.source)
          return;
          
        this.source.noteOff(0); 
        this.source = null;
      };
      
      this.play = function(context, destination) {
        if (0 == this.select.val())
          return null;
          
        if (this.source)
          this.source.noteOff(0);
        
        this.source = context.createBufferSource();
        this.source.looping = this.isLoop();
                   
        var osc = new Oscillator(types[this.select.val()], 440, 1, NUM_SAMPLES, SAMPLE_RATE);
        osc.generate();
        this.source.connect(destination);
        this.source.buffer.getChannelData(0).set(osc.signal);
        this.source.buffer.getChannelData(1).set(osc.signal);
        this.source.noteOn(0);
      }
      
      this.connect = function(destination) {
        this.source.connect(destination);
      }
    } 
    
    
    
    
    
    function NodeGain(gain) {
      this.gain = gain ? gain : '1.0';
      
      this.render = function(container) {
        var controller = $('<input type="text" value="' + this.gain + '" />'); 
        controller.change(this.onGainChanged.bind(this));
        this.controller = controller;
        
        container.append(controller, $(' - Gain'));
      };
      
      this.onGainChanged = function() {
        this.gain = this.getValue();
        if (this.gainNode) {
          this.gainNode.gain.value = this.gain;
        }
      }
      
      this.getValue = function() {
        return parseFloat(this.controller.val());
      }
      
      this.connect = function(context, source, destination) {
        this.gainNode = context.context.createGainNode();
        this.gain = this.getValue();
        this.gainNode.gain.value = this.gain;
        this.gainNode.connect(destination);
        if (source)
          source.connect(this.gainNode);
      }
      
      this.getConnector = function() {
        return this.gainNode;
      }
    }
    
    
    
    
    function Chain(context) {
      this.context = context;
      this.nodes = [];
      this.container = this.render();
      this.source = null;
    }
    
    Chain.prototype.addNode = function(node) {
      this.nodes.push(node);
      node.render(this.container);
    }

    Chain.prototype.getSource = function() {
      return this.source;
    }

    Chain.prototype.setSource = function(source) {
      this.source = source;
      this.sourceContainer.html('');
      var node = $('<span class="source-node" />');
      source.render(node);
      this.sourceContainer.append(node);
    }
    
    Chain.prototype.play = function() {
      this.stop();
      
      if (!this.source)
        return;
      
      var src = this.source;
      var dest = this.context.getDestination(), node = null;
      for (var n in this.nodes) {
        node = this.nodes[n];
        node.connect(this.context, src.source, dest);
        dest = node.getConnector();
      }
      
      this.source.play(this.context, dest);
    }
    
    Chain.prototype.stop = function() {
      if (!this.source)
        return;
      
      this.source.stop();
    }
        
    Chain.prototype.render = function() {
      var container = $('<div class="chain" />');
      var controlls = $('<span class="controlls" />');
      var btnPlay = $('<input type="button" value="Play" />');
      btnPlay.click(this.play.bind(this));
      var btnStop = $('<input type="button" value="Stop" />');
      btnStop.click(this.stop.bind(this));
      controlls.append(btnPlay, $('<br>'), btnStop); 
      container.append(controlls);
      
      var sourceContainer = $('<span class="chain-source" />');
      this.sourceContainer = sourceContainer;
      
      var btnSource = $('<input type="button" class="btn-source" value="Set source" />');
      var btnNode = $('<input type="button" class="btn-node" value="Add node" />');
      btnSource.click(function(chain) {
        return function () {
          selectSourceNode(function(source) {
            chain.setSource(source);
          });
        }        
      }(this));
      btnNode.click(function(chain) {
        return function () {
          chain.addNode(new NodeGain("0.5"));
        }
      }(this));
      
      container.append(btnSource);
      container.append(sourceContainer);
      container.append(btnNode);
      
      return container;
    }
    
    
    
    
    var chains = [];
    function addChain() {
      var chain = new Chain(context);
      chains.push(chain);
      $('#chain-container').append(chain.container);
    }
    
    function play() {
      var chain = null;
      for (var c in chains) {
        chain = chains[c];
        chain.play();
      }
    } 
    
    function stop() {
      var chain = null;
      for (var c in chains) {
        chain = chains[c];
        chain.stop();
      }
    } 
    
  </script>
  </head>
  <body>
    <input type="button" value="Play all" onclick="play();"/> 
    <input type="button" value="Stop all" onclick="stop();"/> 
    <br />
    <div id="chain-container">
    
    </div>
    <input type="button" value="add chain" onclick="addChain();" />
    
    <div id="source-choose">
      
    </div>
  </body>
</html>
